{% load cms_tags menu_tags static sekizai_tags navigation_extras i18n %}
<div class="branding__utility">
  <div class="branding__cluster branding__cluster--left">
    {% for icon in header_contact_icons %}
      {% if icon.url %}
        <a
          href="{{ icon.url }}"
          class="branding-chip branding-chip--emphasis branding-chip--copy"
          style="--chip-bg: {{ icon.background_color }}; --chip-color: {{ icon.icon_color }};"
          aria-label="{{ icon.label }}{% if icon.tooltip %}: {{ icon.tooltip }}{% endif %}"
          data-copy-text="{{ icon.tooltip|default:icon.label|default:''|escape }}"
          {% if icon.open_in_new_tab %}target="_blank" rel="noopener"{% endif %}
        >
      {% else %}
        <span
          class="branding-chip branding-chip--emphasis branding-chip--copy"
          style="--chip-bg: {{ icon.background_color }}; --chip-color: {{ icon.icon_color }};"
          role="button"
          tabindex="0"
          aria-label="{{ icon.label }}{% if icon.tooltip %}: {{ icon.tooltip }}{% endif %}"
          data-copy-text="{{ icon.tooltip|default:icon.label|default:''|escape }}"
        >
      {% endif %}
        {% if icon.icon_class|slice:":5" == "text:" %}
          <span class="branding-chip__icon-text" aria-hidden="true">{{ icon.icon_class|slice:"5:" }}</span>
        {% else %}
          <span class="branding-chip__icon" aria-hidden="true">
            <i class="{{ icon.icon_class }}"></i>
          </span>
        {% endif %}
        {% if icon.tooltip %}
          <span class="branding-chip__tooltip" role="tooltip">{{ icon.tooltip }}</span>
        {% endif %}
        <span class="visually-hidden">{{ icon.label }}</span>
      {% if icon.url %}
        </a>
      {% else %}
        </span>
      {% endif %}
    {% endfor %}
    <button
      type="button"
      class="branding__accessibility accessibility-toggle"
      data-accessibility-toggle
      aria-label="{% trans 'Версия для слабовидящих' %}"
      aria-pressed="false"
    >
      <i class="bi bi-eyeglasses" aria-hidden="true"></i>
      <span class="branding__accessibility-tooltip">{% trans "Режим для слабовидящих" %}</span>
    </button>
  </div>
  <div class="branding__search" role="search">
    <label class="visually-hidden" for="branding-search-input">{% trans "Поиск по сайту" %}</label>
    <input
      id="branding-search-input"
      type="search"
      class="branding__search-input"
      placeholder="{% trans 'Поиск по сайту…' %}"
      autocomplete="off"
      spellcheck="false"
      data-search-input
      aria-controls="site-search-overlay"
      aria-haspopup="dialog"
    />
    <button
      type="button"
      class="branding__search-button"
      data-search-button
      data-search-open
      aria-label="{% trans 'Открыть поиск' %}"
      aria-controls="site-search-overlay"
      aria-expanded="false"
    >
      <i class="bi bi-search" aria-hidden="true"></i>
    </button>
    <div
      class="branding__search-panel site-search__panel"
      data-search-panel
      role="region"
      aria-live="polite"
      hidden
    >
      <div class="site-search__status is-hidden" data-search-status></div>
      <div class="site-search__results" data-search-results></div>
      <p class="site-search__empty" data-search-empty>{% trans "Введите запрос, чтобы увидеть результаты" %}</p>
    </div>
  </div>
  <div class="branding__cluster branding__cluster--right">
    {% for icon in header_social_icons %}
      {% if icon.url %}
        <a
          href="{{ icon.url }}"
          class="branding-chip branding-chip--emphasis"
          style="--chip-bg: {{ icon.background_color }}; --chip-color: {{ icon.icon_color }};"
          aria-label="{{ icon.label }}{% if icon.tooltip %}: {{ icon.tooltip }}{% endif %}"
          {% if icon.open_in_new_tab %}target="_blank" rel="noopener"{% endif %}
        >
      {% else %}
        <span
          class="branding-chip branding-chip--emphasis"
          style="--chip-bg: {{ icon.background_color }}; --chip-color: {{ icon.icon_color }};"
          role="button"
          tabindex="0"
          aria-label="{{ icon.label }}{% if icon.tooltip %}: {{ icon.tooltip }}{% endif %}"
        >
      {% endif %}
        {% if icon.icon_class|slice:":5" == "text:" %}
          <span class="branding-chip__icon-text" aria-hidden="true">{{ icon.icon_class|slice:"5:" }}</span>
        {% else %}
          <span class="branding-chip__icon" aria-hidden="true">
            <i class="{{ icon.icon_class }}"></i>
          </span>
        {% endif %}
        {% if icon.tooltip %}
          <span class="branding-chip__tooltip" role="tooltip">{{ icon.tooltip }}</span>
        {% endif %}
        <span class="visually-hidden">{{ icon.label }}</span>
      {% if icon.url %}
        </a>
      {% else %}
        </span>
      {% endif %}
    {% endfor %}
  </div>
  <div class="branding__copy-toast" data-copy-toast hidden>
    {% trans "Скопировано" %}
  </div>
</div>
<div class="branding__nav">
<aside id="fly-nav" class="fly-nav" data-fly-nav>
  <div class="fly-nav__inner">
    <nav class="fly-nav__menu" aria-label="Основная навигация">
      <ul class="fly-nav__list">
        {% show_menu 0 1 1 100 "menu/sidebar_menu.html" %}
      </ul>
    </nav>
  </div>
</aside>
<div
  class="site-search"
  data-site-search
  data-search-endpoint="{% url 'site-search' %}"
  data-empty-label="{% trans 'Введите запрос, чтобы увидеть результаты' %}"
  data-no-results-label="{% trans 'По запросу «{query}» ничего не найдено.' %}"
  data-loading-label="{% trans 'Ищем…' %}"
  data-error-label="{% trans 'Не удалось выполнить поиск. Попробуйте ещё раз.' %}"
  id="site-search-overlay"
  hidden
>
  <div class="site-search__backdrop" data-search-close></div>
</div>
<button
  type="button"
  class="fly-nav__mobile-toggle"
  data-fly-nav-mobile-toggle
  aria-controls="fly-nav"
  aria-expanded="false"
  aria-label="Открыть меню"
>
  <span class="fly-nav__mobile-icon" aria-hidden="true"></span>
</button>
<div class="fly-nav__mobile-backdrop" data-fly-nav-mobile-backdrop hidden></div>
</div>

{% addtoblock "css" %}
<style>
  :root {
    --fly-nav-width: 310px;
    --fly-nav-collapsed: 64px;
    --fly-nav-bg: rgba(255, 255, 255, 0.96);
    --fly-nav-border: rgba(37, 99, 235, 0.12);
    --fly-nav-accent: #2563eb;
    --fly-nav-shadow: 0 22px 48px rgba(16, 24, 40, 0.16);
  }
  .fly-nav {
    position: fixed;
    top: 52%;
    right: 0;
    transform: translateY(-52%);
    z-index: 999;
    width: var(--fly-nav-width);
    max-height: 82vh;
    display: flex;
    flex-direction: column;
    transition: width 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
    pointer-events: auto;
  }
  .fly-nav__inner {
    background: var(--fly-nav-bg);
    color: #161a20;
    border-radius: 16px;
    padding: 1.1rem 0.9rem 1.1rem 0.9rem;
    box-shadow: var(--fly-nav-shadow);
    backdrop-filter: blur(14px);
    border: 1px solid var(--fly-nav-border);
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
  }
  .fly-nav__menu {
    overflow: hidden;
  }
  .fly-nav__list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .fly-nav__item {
    position: relative;
  }
  .fly-nav__item--utility {
    margin-bottom: 0.25rem;
  }
  .fly-nav__link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.55rem 0.85rem;
    border-radius: 12px;
    color: inherit;
    text-decoration: none;
    min-width: 0;
    transition: transform 0.2s ease, background-color 0.2s ease, color 0.2s ease;
  }
  .fly-nav__link:hover,
  .fly-nav__link:focus-visible {
    background: rgba(37, 99, 235, 0.16);
    color: var(--fly-nav-accent);
    transform: translateX(-4px);
    outline: none;
  }
  .fly-nav__item--active > .fly-nav__link {
    background: rgba(37, 99, 235, 0.18);
    color: var(--fly-nav-accent);
    box-shadow: inset 0 0 0 1px rgba(37, 99, 235, 0.35);
  }
  .fly-nav__icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    min-width: 40px;
    min-height: 40px;
    flex: 0 0 40px;
    border-radius: 12px;
    background: rgba(37, 99, 235, 0.12);
    color: var(--fly-nav-accent);
    font-size: 1.2rem;
  }
  .fly-nav__icon i {
    line-height: 1;
  }
  .fly-nav__label {
    font-size: 0.94rem;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
    flex: 1 1 auto;
    min-width: 0;
    transition: opacity 0.2s ease;
  }
  .fly-nav__link--button {
    border: none;
    background: transparent;
    width: 100%;
    padding: 0.55rem 0.85rem;
    text-align: left;
    font: inherit;
    color: inherit;
    cursor: pointer;
  }
  .fly-nav__link--button.is-active {
    background: rgba(37, 99, 235, 0.18);
    color: var(--fly-nav-accent);
    box-shadow: inset 0 0 0 1px rgba(37, 99, 235, 0.35);
  }
  .fly-nav--collapsed {
    width: var(--fly-nav-collapsed);
  }
  .fly-nav--collapsed .fly-nav__inner {
    padding: 0.8rem 0.45rem;
  }
  .fly-nav--collapsed .fly-nav__link {
    justify-content: center;
    padding: 0.5rem;
  }
  .fly-nav--collapsed .fly-nav__label {
    position: absolute;
    right: calc(100% + 0.5rem);
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.97);
    border-radius: 8px;
    padding: 0.4rem 0.6rem;
    font-size: 0.78rem;
    opacity: 0;
    pointer-events: none;
    box-shadow: 0 12px 28px rgba(15, 23, 42, 0.18);
    transition: opacity 0.18s ease;
  }
  .fly-nav--collapsed .fly-nav__item:hover .fly-nav__label,
  .fly-nav--collapsed .fly-nav__item:focus-within .fly-nav__label {
    opacity: 1;
  }
  .fly-nav--collapsed .fly-nav__item:hover .fly-nav__link,
  .fly-nav--collapsed .fly-nav__item:focus-within .fly-nav__link {
    transform: translateX(-6px);
  }
  .fly-nav__child-list {
    display: none;
    list-style: none;
    padding: 0.35rem 0 0 2rem;
    margin: 0;
    gap: 0.35rem;
    flex-direction: column;
  }
  .fly-nav__item--expanded > .fly-nav__child-list,
  .fly-nav__item--active > .fly-nav__child-list {
    display: flex;
  }
  .fly-nav__child-link {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    color: rgba(22, 26, 32, 0.75);
    font-size: 0.82rem;
    padding: 0.32rem 0.45rem;
    border-radius: 6px;
    text-decoration: none;
    transition: background-color 0.2s ease;
  }
  .fly-nav__child-link:hover,
  .fly-nav__child-link:focus-visible {
    background: rgba(37, 99, 235, 0.18);
    color: var(--fly-nav-accent);
    outline: none;
  }
  .site-search {
    position: fixed;
    inset: 0;
    z-index: 900;
  }
  .site-search[hidden] {
    display: none;
  }
  .site-search:not(.is-open) {
    pointer-events: none;
  }
  .site-search__backdrop {
    position: absolute;
    inset: 0;
    backdrop-filter: blur(18px);
    background: rgba(15, 23, 42, 0.45);
    pointer-events: auto;
  }
  .site-search__panel {
    position: absolute;
    top: calc(100% + 0.75rem);
    left: 0;
    width: 100%;
    max-height: min(70vh, 520px);
    background: #fff;
    border-radius: 1rem;
    box-shadow: 0 24px 60px rgba(15, 23, 42, 0.18);
    border: 1px solid rgba(37, 99, 235, 0.12);
    padding: 1.1rem 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.85rem;
    pointer-events: none;
    opacity: 0;
    transform: translateY(-8px);
    transition: opacity 0.25s ease, transform 0.25s ease;
    z-index: 50;
  }
  [data-search-panel].is-open {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }
  .site-search__status {
    font-size: 0.92rem;
    color: rgba(15, 23, 42, 0.6);
  }
  .site-search__results {
    display: grid;
    gap: 0.65rem;
    --result-animation-duration: 260ms;
    max-height: min(45vh, 360px);
    overflow-y: auto;
    padding-right: 0.35rem;
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.25s ease, transform 0.25s ease;
  }
  .site-search__results.is-visible {
    opacity: 1;
    transform: translateY(0);
  }
  .site-search__result {
    position: relative;
    display: flex;
    align-items: flex-start;
    gap: 0.85rem;
    padding: 0.85rem 0.95rem;
    border-radius: 14px;
    border: 1px solid rgba(37, 99, 235, 0.08);
    background: rgba(248, 250, 255, 0.65);
    transition: border-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    text-decoration: none;
    opacity: 0;
    transform: translateY(14px) scale(0.97);
    animation: site-search-result var(--result-animation-duration) ease forwards;
    animation-delay: var(--site-search-delay, 0ms);
  }
  .site-search__result:hover,
  .site-search__result:focus-visible {
    border-color: rgba(37, 99, 235, 0.45);
    box-shadow: 0 14px 30px rgba(15, 23, 42, 0.12);
    transform: translateY(-1px);
  }
  .site-search__result-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 42px;
    height: 42px;
    border-radius: 12px;
    background: rgba(37, 99, 235, 0.12);
    color: var(--fly-nav-accent);
    font-size: 1.25rem;
    flex: 0 0 auto;
  }
  .site-search__result-body {
    display: grid;
    gap: 0.25rem;
  }
  .site-search__result-title {
    font-size: 1.02rem;
    font-weight: 600;
    color: #0f172a;
    margin: 0;
  }
  .site-search__result-meta {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.78rem;
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    color: rgba(37, 99, 235, 0.85);
  }
  .site-search__result-snippet {
    margin: 0;
    font-size: 0.9rem;
    line-height: 1.4;
    color: rgba(15, 23, 42, 0.72);
  }
  .site-search__empty {
    font-size: 0.95rem;
    color: rgba(15, 23, 42, 0.58);
    margin: 0;
  }
  .site-search__empty.is-hidden,
  .site-search__status.is-hidden {
    display: none;
  }
  body.site-search-open {
    overflow: hidden;
  }
  body.site-search-open .fly-nav__mobile-toggle {
    opacity: 0;
    pointer-events: none;
  }
  @keyframes site-search-result {
    from {
      opacity: 0;
      transform: translateY(14px) scale(0.97);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  .fly-nav__mobile-toggle {
    display: none;
    position: fixed;
    top: 62px;
    right: 16px;
    width: 54px;
    height: 54px;
    border-radius: 50%;
    border: none;
    background: var(--fly-nav-accent);
    color: #fff;
    box-shadow: 0 18px 38px rgba(37, 99, 235, 0.35);
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1001;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .fly-nav__mobile-toggle:hover {
    box-shadow: 0 20px 42px rgba(37, 99, 235, 0.4);
  }
  .fly-nav__mobile-toggle:active {
    transform: scale(0.96);
  }
  .fly-nav__mobile-toggle:focus-visible {
    outline: 2px solid rgba(255, 255, 255, 0.7);
    outline-offset: 3px;
  }
  .fly-nav__mobile-icon {
    position: relative;
    display: block;
    width: 22px;
    height: 2px;
    background: currentColor;
    border-radius: 2px;
    transition: background 0.24s ease;
  }
  .fly-nav__mobile-icon::before,
  .fly-nav__mobile-icon::after {
    content: "";
    position: absolute;
    left: 0;
    width: 22px;
    height: 2px;
    background: currentColor;
    border-radius: 2px;
    transition: transform 0.24s ease, opacity 0.24s ease;
  }
  .fly-nav__mobile-icon::before {
    transform: translateY(-6px);
  }
  .fly-nav__mobile-icon::after {
    transform: translateY(6px);
  }
  .fly-nav__mobile-toggle.is-active .fly-nav__mobile-icon {
    background: transparent;
  }
  .fly-nav__mobile-toggle.is-active .fly-nav__mobile-icon::before {
    transform: rotate(45deg);
  }
  .fly-nav__mobile-toggle.is-active .fly-nav__mobile-icon::after {
    transform: rotate(-45deg);
  }
  .fly-nav__mobile-backdrop {
    display: none;
  }
  body.fly-nav-mobile-open {
    overflow: hidden;
  }
  @media (max-width: 991.98px) {
    .fly-nav {
      top: 0;
      bottom: 0;
      right: 0;
      transform: translateX(110%);
      width: min(320px, 86vw);
      max-height: none;
      pointer-events: none;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .fly-nav.fly-nav--mobile-open {
      transform: translateX(0);
      pointer-events: auto;
      box-shadow: var(--fly-nav-shadow);
    }
    .fly-nav__inner {
      height: 100%;
      padding: 1.6rem 1.2rem 2rem;
      overflow-y: auto;
      border-radius: 0;
      gap: 1rem;
    }
    .fly-nav__list {
      gap: 0.75rem;
    }
    .fly-nav__label {
      display: none;
    }
    .fly-nav.fly-nav--mobile-open .fly-nav__label {
      display: block;
    }
    .fly-nav--collapsed {
      width: min(320px, 86vw);
    }
    .fly-nav--collapsed .fly-nav__inner {
      padding: 1.6rem 1.2rem 2rem;
    }
    .fly-nav--collapsed .fly-nav__link {
      justify-content: flex-start;
      padding: 0.65rem 0.85rem;
    }
    .fly-nav--collapsed .fly-nav__label {
      position: static;
      right: auto;
      top: auto;
      transform: none;
      background: transparent;
      padding: 0;
      opacity: 1;
      pointer-events: auto;
      box-shadow: none;
    }
    .fly-nav__mobile-toggle {
      display: inline-flex;
      top: 42px;
      right: 16px;
    }
    .site-search__panel {
      width: 100%;
      max-height: min(78vh, 520px);
      border-radius: 14px;
      left: 0;
    }
    .fly-nav__mobile-backdrop {
      display: block;
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 998;
    }
    .fly-nav__mobile-backdrop.is-active {
      opacity: 1;
      pointer-events: auto;
    }
  }
</style>
{% endaddtoblock %}

{% addtoblock "js" %}
<script>
  (function () {
    "use strict";

    var copyToast = document.querySelector('[data-copy-toast]');
    var copyToastTimer = null;

    function showCopyToast() {
      if (!copyToast) {
        return;
      }
      copyToast.removeAttribute('hidden');
      copyToast.classList.add('is-visible');
      if (copyToastTimer) {
        window.clearTimeout(copyToastTimer);
      }
      copyToastTimer = window.setTimeout(function () {
        copyToast.classList.remove('is-visible');
      }, 1600);
    }

    function fallbackCopy(text) {
      try {
        var textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.setAttribute('readonly', '');
        textarea.style.position = 'absolute';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showCopyToast();
      } catch (error) {
        window.prompt('Скопируйте значение', text);
      }
    }

    function copyValue(text) {
      if (!text) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard
          .writeText(text)
          .then(function () {
            showCopyToast();
          })
          .catch(function () {
            fallbackCopy(text);
          });
      } else {
        fallbackCopy(text);
      }
    }

    (function bindCopyTriggers() {
      var copyChips = document.querySelectorAll('.branding-chip--copy[data-copy-text]');
      if (!copyChips.length) {
        return;
      }
      copyChips.forEach(function (chip) {
        function triggerCopy(event) {
          event.preventDefault();
          var text = chip.getAttribute('data-copy-text');
          if (!text) return;
          copyValue(text.trim());
        }
        chip.addEventListener('click', triggerCopy);
        chip.addEventListener('keydown', function (event) {
          if (event.key === 'Enter' || event.key === ' ') {
            triggerCopy(event);
          }
        });
      });
    })();

    var nav = document.querySelector('[data-fly-nav]');
    if (!nav) return;

    var collapseClass = 'fly-nav--collapsed';
    var hoverClass = 'fly-nav--hover';
    var mobileOpenClass = 'fly-nav--mobile-open';
    var bodyMobileClass = 'fly-nav-mobile-open';
    var hoverTimeout;
    var mobileToggle = document.querySelector('[data-fly-nav-mobile-toggle]');
    var mobileBackdrop = document.querySelector('[data-fly-nav-mobile-backdrop]');
    var closeSearchIfOpen = function () {
      return false;
    };

    function isMobile() {
      return window.innerWidth < 992;
    }

    function setCollapsed(state) {
      nav.classList.toggle(collapseClass, state);
    }

    function openNav() {
      if (isMobile()) return;
      clearTimeout(hoverTimeout);
      nav.classList.add(hoverClass);
      setCollapsed(false);
    }

    function scheduleClose() {
      if (isMobile()) return;
      nav.classList.remove(hoverClass);
      hoverTimeout = setTimeout(function () {
        setCollapsed(true);
      }, 150);
    }

    function openMobileNav() {
      if (!isMobile()) return;
      clearTimeout(hoverTimeout);
      nav.classList.add(mobileOpenClass);
      nav.classList.remove(hoverClass);
      setCollapsed(false);
      document.body.classList.add(bodyMobileClass);
      if (mobileToggle) {
        mobileToggle.classList.add('is-active');
        mobileToggle.setAttribute('aria-expanded', 'true');
        mobileToggle.setAttribute('aria-label', 'Закрыть меню');
      }
      if (mobileBackdrop) {
        mobileBackdrop.classList.add('is-active');
        mobileBackdrop.removeAttribute('hidden');
      }
    }

    function closeMobileNav(force) {
      var wasOpen = nav.classList.contains(mobileOpenClass);
      if (!wasOpen && force !== true) {
        return;
      }
      nav.classList.remove(mobileOpenClass);
      nav.classList.remove(hoverClass);
      setCollapsed(true);
      document.body.classList.remove(bodyMobileClass);
      if (mobileToggle) {
        mobileToggle.classList.remove('is-active');
        mobileToggle.setAttribute('aria-expanded', 'false');
        mobileToggle.setAttribute('aria-label', 'Открыть меню');
      }
      if (mobileBackdrop) {
        mobileBackdrop.classList.remove('is-active');
        mobileBackdrop.setAttribute('hidden', '');
      }
    }

    function handleHover(event) {
      if (event.type === 'mouseenter') {
        openNav();
      } else if (event.type === 'mouseleave') {
        scheduleClose();
      }
    }

    function handleFocus(event) {
      if (!nav.contains(event.target) || isMobile()) return;
      openNav();
    }

    function handleBlur(event) {
      if (isMobile() || nav.contains(event.relatedTarget)) return;
      scheduleClose();
    }

    nav.addEventListener('mouseenter', handleHover);
    nav.addEventListener('mouseleave', handleHover);
    nav.addEventListener('focusin', handleFocus);
    nav.addEventListener('focusout', handleBlur);

    if (mobileToggle) {
      mobileToggle.addEventListener('click', function () {
        if (nav.classList.contains(mobileOpenClass)) {
          closeMobileNav();
        } else {
          openMobileNav();
        }
      });
    }

    if (mobileBackdrop) {
      mobileBackdrop.addEventListener('click', function () {
        closeMobileNav();
      });
    }

    nav.addEventListener('click', function (event) {
      if (isMobile() && event.target.closest('a')) {
        closeMobileNav();
      }
    });

    var searchOverlay = document.querySelector('[data-site-search]');
    if (searchOverlay) {
      var searchEndpoint = searchOverlay.getAttribute('data-search-endpoint');
      var searchOpeners = document.querySelectorAll('[data-search-open]');
      var searchInputs = Array.prototype.slice.call(document.querySelectorAll('[data-search-input]'));
      var searchButtons = Array.prototype.slice.call(document.querySelectorAll('[data-search-button]'));
      var searchPanel = document.querySelector('[data-search-panel]');
      var searchResults = document.querySelector('[data-search-results]');
      var searchEmpty = document.querySelector('[data-search-empty]');
      var searchStatus = document.querySelector('[data-search-status]');
      var searchClosers = searchOverlay.querySelectorAll('[data-search-close]');
      var searchAbort = null;
      var searchDebounce = null;
      var lastQuery = '';
      var emptyDefaultMessage = searchOverlay.getAttribute('data-empty-label') || (searchEmpty ? searchEmpty.textContent.trim() : '');
      var loadingMessage = searchOverlay.getAttribute('data-loading-label') || 'Ищем…';
      var errorMessage = searchOverlay.getAttribute('data-error-label') || 'Не удалось выполнить поиск. Попробуйте ещё раз.';
      var noResultsTemplate = searchOverlay.getAttribute('data-no-results-label') || 'По запросу «{query}» ничего не найдено.';

      function setSearchButtonsExpanded(isOpen) {
        if (!searchButtons.length) {
          return;
        }
        searchButtons.forEach(function (btn) {
          btn.setAttribute('aria-expanded', String(!!isOpen));
        });
      }

      function focusSearchInput(preferredInput) {
        if (!searchInputs.length) {
          return;
        }
        var target = null;
        if (preferredInput && searchInputs.indexOf(preferredInput) !== -1) {
          target = preferredInput;
        } else if (searchInputs.indexOf(document.activeElement) !== -1) {
          target = document.activeElement;
        } else {
          target = searchInputs[0];
        }
        window.requestAnimationFrame(function () {
          if (document.activeElement !== target) {
            target.focus();
          }
          var length = target.value.length;
          if (typeof target.setSelectionRange === 'function') {
            try {
              target.setSelectionRange(length, length);
            } catch (error) {
              /* ignore */
            }
          }
        });
      }

      function resolveInputForOpener(opener) {
        if (!searchInputs.length) {
          return null;
        }
        if (!opener) {
          return searchInputs[0];
        }
        var scope = opener.closest('.branding__search');
        if (scope) {
          var scopedInput = scope.querySelector('[data-search-input]');
          if (scopedInput) {
            return scopedInput;
          }
        }
        return searchInputs[0];
      }

      function setStatus(message) {
        if (!searchStatus) return;
        if (message) {
          searchStatus.textContent = message;
          searchStatus.classList.remove('is-hidden');
        } else {
          searchStatus.textContent = '';
          searchStatus.classList.add('is-hidden');
        }
      }

      function resetResults(message) {
        if (searchResults) {
          searchResults.innerHTML = '';
          searchResults.classList.remove('is-visible');
        }
        if (searchEmpty) {
          if (message) {
            searchEmpty.textContent = message;
            searchEmpty.classList.remove('is-hidden');
          } else {
            searchEmpty.classList.add('is-hidden');
          }
        }
      }

      function openSearch(options) {
        var focusTarget = options && options.focusTarget ? options.focusTarget : null;
        closeMobileNav(true);
        nav.classList.remove(hoverClass);
        setCollapsed(true);
        if (searchOverlay.hasAttribute('hidden')) {
          searchOverlay.removeAttribute('hidden');
        }
        var wasClosed = !searchOverlay.classList.contains('is-open');
        if (wasClosed) {
          searchOverlay.classList.add('is-open');
          document.body.classList.add('site-search-open');
          setSearchButtonsExpanded(true);
          if (!lastQuery) {
            resetResults(emptyDefaultMessage);
            setStatus('');
          }
        }
        if (searchPanel) {
          if (searchPanel.hasAttribute('hidden')) {
            searchPanel.removeAttribute('hidden');
          }
          window.requestAnimationFrame(function () {
            searchPanel.classList.add('is-open');
          });
        }
        focusSearchInput(focusTarget);
      }

      function closeSearch() {
        if (!searchOverlay.classList.contains('is-open')) {
          return;
        }
        searchOverlay.classList.remove('is-open');
        document.body.classList.remove('site-search-open');
        setSearchButtonsExpanded(false);
        resetSearchUI(true);
        if (searchInputs.length) {
          searchInputs.forEach(function (input) {
            input.blur();
          });
        }
        if (searchPanel) {
          searchPanel.classList.remove('is-open');
        }
        window.setTimeout(function () {
          searchOverlay.setAttribute('hidden', '');
          if (searchPanel) {
            searchPanel.setAttribute('hidden', '');
          }
        }, 220);
      }

      function performSearch(query) {
        if (!searchEndpoint || !query) {
          resetResults(emptyDefaultMessage);
          setStatus('');
          return;
        }
        lastQuery = query;
        if (searchAbort) {
          searchAbort.abort();
        }
        searchAbort = new AbortController();
        setStatus(loadingMessage);
        if (searchResults) {
          searchResults.innerHTML = '';
        }
        if (searchEmpty) {
          searchEmpty.classList.add('is-hidden');
        }
        fetch(searchEndpoint + '?q=' + encodeURIComponent(query), {
          headers: { Accept: 'application/json' },
          signal: searchAbort.signal,
        })
          .then(function (response) {
            if (!response.ok) {
              throw new Error('Network error');
            }
            return response.json();
          })
          .then(function (payload) {
            renderResults(payload && payload.results ? payload.results : [], query);
          })
          .catch(function (error) {
            if (error.name === 'AbortError') {
              return;
            }
            resetResults('');
            setStatus(errorMessage);
          });
      }

      function renderResults(items, query) {
        setStatus('');
        if (!searchResults) {
          return;
        }
        searchResults.innerHTML = '';
        if (!items.length) {
          var noResultsText = noResultsTemplate.replace('{query}', query);
          if (searchEmpty) {
            searchEmpty.textContent = noResultsText;
            searchEmpty.classList.remove('is-hidden');
          }
          return;
        }
        if (searchEmpty) {
          searchEmpty.classList.add('is-hidden');
        }
        var fragment = document.createDocumentFragment();
        items.forEach(function (item, index) {
          if (!item || !item.url) {
            return;
          }
          var link = document.createElement('a');
          link.className = 'site-search__result';
          link.href = item.url;
          link.setAttribute('data-result-type', item.type || 'page');
          if (item.external) {
            link.target = '_blank';
            link.rel = 'noopener';
            link.dataset.resultExternal = 'true';
          }

          var icon = document.createElement('span');
          icon.className = 'site-search__result-icon';
          var iconClass = item.icon || 'bi bi-search';
          icon.innerHTML = '<i class=\"' + iconClass + '\" aria-hidden=\"true\"></i>';
          var type = (item.type || '').toLowerCase();
          if (type === 'page') {
            icon.style.background = 'rgba(16, 185, 129, 0.18)';
            icon.style.color = '#047857';
          } else if (type === 'document') {
            icon.style.background = 'rgba(37, 99, 235, 0.15)';
            icon.style.color = '#1d4ed8';
          }

          var body = document.createElement('div');
          body.className = 'site-search__result-body';

          var meta = document.createElement('span');
          meta.className = 'site-search__result-meta';
          meta.textContent = item.label || '';

          var title = document.createElement('h3');
          title.className = 'site-search__result-title';
          title.textContent = item.title || '';

          body.appendChild(meta);
          body.appendChild(title);

          if (item.description) {
            var snippet = document.createElement('p');
            snippet.className = 'site-search__result-snippet';
            snippet.textContent = item.description;
            body.appendChild(snippet);
          }

          link.appendChild(icon);
          link.appendChild(body);
          link.style.setProperty('--site-search-delay', Math.min(index * 60, 360) + 'ms');
          fragment.appendChild(link);
        });
        searchResults.appendChild(fragment);
        searchResults.classList.add('is-visible');
      }

      function resetSearchUI(clearInput = true) {
        if (clearInput && searchInputs.length) {
          searchInputs.forEach(function (input) {
            input.value = '';
          });
        }
        lastQuery = '';
        if (searchAbort) {
          searchAbort.abort();
          searchAbort = null;
        }
        resetResults(emptyDefaultMessage);
        setStatus('');
      }

      function scheduleSearch(query) {
        if (searchDebounce) {
          clearTimeout(searchDebounce);
        }
        if (!query) {
          resetSearchUI(false);
          return;
        }
        searchDebounce = window.setTimeout(function () {
          performSearch(query);
        }, 240);
      }

      if (searchOpeners.length) {
        Array.prototype.forEach.call(searchOpeners, function (btn) {
          btn.addEventListener('click', function () {
            openSearch({ focusTarget: resolveInputForOpener(btn) });
          });
        });
      }

      if (searchClosers.length) {
        Array.prototype.forEach.call(searchClosers, function (btn) {
          btn.addEventListener('click', function () {
            closeSearch();
          });
        });
      }

      if (searchInputs.length) {
        searchInputs.forEach(function (input) {
          input.addEventListener('focus', function () {
            openSearch({ focusTarget: input });
          });
          input.addEventListener('click', function () {
            openSearch({ focusTarget: input });
          });
          input.addEventListener('input', function () {
            var value = input.value || '';
            var trimmed = value.trim();
            if (!trimmed) {
              scheduleSearch('');
              return;
            }
            scheduleSearch(trimmed);
          });
        });
      }

      if (searchResults) {
        searchResults.addEventListener('click', function (event) {
          var link = event.target.closest('a.site-search__result');
          if (!link) {
            return;
          }
          if (!link.dataset.resultExternal) {
            closeSearch();
          }
        });
      }

      searchOverlay.addEventListener('click', function (event) {
        if (
          event.target === searchOverlay ||
          event.target.classList.contains('site-search__backdrop')
        ) {
          closeSearch();
        }
      });

      closeSearchIfOpen = function () {
        if (searchOverlay.classList.contains('is-open')) {
          closeSearch();
          return true;
        }
        return false;
      };
    }

    document.addEventListener('keydown', function (event) {
      if (event.key === 'Escape') {
        if (closeSearchIfOpen()) {
          event.preventDefault();
          return;
        }
        closeMobileNav();
      }
    });

    setCollapsed(true);

    window.addEventListener('resize', function () {
      if (isMobile()) {
        nav.classList.remove(hoverClass);
        if (!nav.classList.contains(mobileOpenClass)) {
          setCollapsed(true);
        }
      } else {
        closeMobileNav(true);
        nav.classList.remove(hoverClass);
        setCollapsed(true);
      }
    });
  })();
</script>
{% endaddtoblock %}
